---
title: 'Notion Blogã«ã‚¿ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹'
published: true
draft: false
date: 20200902
ogp: 'https://firebasestorage.googleapis.com/v0/b/titanic-rising.appspot.com/o/_2020-09-02_14.39.20.png?alt=media&token=58096dce-9f95-4db6-ab82-a00346421ad5'
tag:
  - Tech
  - TypeScript
---

æœ€è¿‘ãƒ–ãƒ­ã‚°ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ã„ã†ã‹å†…å®¹ãŒãƒ–ãƒ¬ãƒ–ãƒ¬ã§ãªã‚“ã§ã‚‚ã‚ã‚Šãªæ„Ÿã˜ã«ãªã£ã¦ããŸã®ã§ã‚¿ã‚°æ©Ÿèƒ½ã‚’ã¤ã‘ã¦æ•´ç†ã—ã¦ã„ããŸã„ã¨æ€ã†ã€‚

æˆæœç‰©ã¯ä¾‹ã®å¦‚ãã“ã®ãƒ–ãƒ­ã‚°ãã®ã‚‚ã®ã§ã™ã€‚

## Notion å´ã®è¨­å®š

ã¨ã‚Šã‚ãˆãšã‚¿ã‚°ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

ã¾ã‚ã“ã®è¾ºã®ãƒ‡ãƒ¼ã‚¿ã¯ãªã‚“ã§ã‚‚ã„ã„ã€‚

<img
  width={1518}
  height={572}
  src={`https://res.cloudinary.com/dw86z2fnr/image/upload/v1620383433/titanicrising.jp/notion-blog-tag/_2020-09-01_13.37.41_vcmt0p.png`}
/>

ãã—ãŸã‚‰ãƒ¡ã‚¤ãƒ³ã®è¨˜äº‹ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã•ã£ãã® Tag ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚Šã¾ã™ã€‚

<img
  width={2242}
  height={372}
  src={`https://res.cloudinary.com/dw86z2fnr/image/upload/v1620383433/titanicrising.jp/notion-blog-tag/_2020-09-01_13.38.46_xvzfd7.png`}
/>

ã‚ã¨ã¯è¨˜äº‹ãƒ†ãƒ¼ãƒ–ãƒ«å´ã‹ã‚‰ã•ã£ãä½œæˆã—ãŸã‚¿ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã™ã‚‹ã ã‘ã€‚

<img
  width={1300}
  height={530}
  src={`https://res.cloudinary.com/dw86z2fnr/image/upload/v1620383432/titanicrising.jp/notion-blog-tag/_2020-09-01_13.39.02_lm1f7m.png`}
/>

## Next.js å´ã®è¨­å®š

ã¨ã‚Šã‚ãˆãšä¸€è¦§è¡¨ç¤ºã«ã‚¿ã‚°ã‚’å‡ºã—ãŸã„ã€‚å‡ºã•ã›ã¦ãã ã•ã„ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã¿ã‚‹ã¨ Notion ã®ãƒ‡ãƒ¼ã‚¿ã®å‘¼ã³å‡ºã—ã¯ getTableData é–¢æ•°ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ã“ã“ã‚’ã„ã˜ã£ã¦ã¿ã‚‹ã€‚

```tsx
// src/lib/notion/getTableData.ts

//ã€€ç•¥
schemaKeys.forEach(async (key) => {
  // might be undefined
  let val = props[key] && props[key][0][0]

  // authors and blocks are centralized
  if (val && props[key][0][1]) {
    const type = props[key][0][1][0]

    switch (type[0]) {
      case 'a': // link
        val = type[1]
        break
      case 'u': // user
        val = props[key]
          .filter((arr: any[]) => arr.length > 1)
          .map((arr: any[]) => arr[1][0][1])
        break
      case 'p': // page (block)
        const page = col.recordMap.block[type[1]]
          row.id = page.value.id
          val = page.value.properties.title[0][0]
        }

        break
      case 'd': // date
        // start_date: 2019-06-18
        // start_time: 07:00
        // time_zone: Europe/Berlin, America/Los_Angeles

        if (!type[1].start_date) {
          break
        }
        // initial with provided date
        const providedDate = new Date(
          type[1].start_date + ' ' + (type[1].start_time || '')
        ).getTime()

        // calculate offset from provided time zone
        const timezoneOffset =
          new Date(
            new Date().toLocaleString('en-US', {
              timeZone: type[1].time_zone
            })
          ).getTime() - new Date().getTime()

        // initialize subtracting time zone offset
        val = new Date(providedDate - timezoneOffset).getTime()
        break
      default:
        console.error('unknown type', type[0], type)
        break
    }
  }
```

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã® type ã¯ case ã§ã„ã†'p'ã«å¼•ã£ã‹ã‹ã‚‹ã®ã§ã“ã“ã®æ¡ä»¶åˆ†å²ã‚’ç·¨é›†ã™ã‚‹ã€‚

æ¬¡ã«è¤‡æ•°ã®ã‚¿ã‚°ãŒå…¥ã£ã¦ããŸå ´åˆã«å¯¾å¿œã™ã‚‹ãŸã‚ã€ä¸Šè¨˜ã® const type = ã®éƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‹ã€‚

ã‚‚ã†ã“ã‚Œã¯èª¬æ˜ã§ããªã„ã‘ã©ã“ã‚Œã§å‹•ãã€‚

```tsx
// src/lib/notion/getTableData.ts

const type =
  props[key].length < 2
    ? props[key][0][1][0]
    : [
        props[key][0][1][0][0],
        ...props[key]
          .map((p) => p[1])
          .filter((f) => !!f)
          .map((fp) => fp[0][1])
      ]
```

æ¬¡ã« Notion_id ã‹ã‚‰ã‚¿ã‚°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ getTagData é–¢æ•°ã‚’æ–°ãŸã«ä½œæˆã™ã‚‹ã€‚

```tsx
// src/lib/notion/getTagData.ts

import rpc, { values } from './rpc'

export default async function getTagData(pageId: string) {
  const obj = {
    Color: null,
    Title: null,
    Slug: null
  }

  try {
    const data = await loadPageChunk({ pageId })
    const blocks = values(data.recordMap.block)

    if (blocks[0].value?.properties) {
      const props = blocks[0].value?.properties
      obj.Color = props['n<}n'][0]
      obj.Title = props['title'][0]
      obj.Slug = props['e;z{'][0]
    }
  } catch (err) {
    console.error(`Failed to load pageData for ${pageId}`, err)
  }

  if (obj.Title && obj.Slug && obj.Color) {
    return obj
  }
}

export function loadPageChunk({
  pageId,
  limit = 100,
  cursor = { stack: [] },
  chunkNumber = 0,
  verticalColumns = false
}: any): any {
  return rpc('loadPageChunk', {
    pageId,
    limit,
    cursor,
    chunkNumber,
    verticalColumns
  })
}
```

ã“ã‚Œã‚’ã•ã£ãã® Switch æ–‡ã®ä¸­ã§å‘¼ã³å‡ºã—ã¦ã‚ã’ã‚‹ã€‚

```tsx
// src/lib/notion/getTableData.ts

// ç•¥
case 'p':
  const page = col.recordMap.block[type[1]]
  if (page) {
    row.id = page.value.id
    val = page.value.properties.title[0][0]
  }

	//è¿½åŠ ï¼ï¼ï¼
  if (!page) {
    const tagsPromise = type
      .map(async (t) => {
        const tag = await getTagData(t)
        return tag
      })
      .filter((_, i) => i !== 0)

    const tags = await Promise.all(tagsPromise)
    val = tags
  }
  break
```

æ–°ãŸã«ä½œæˆã—ãŸ Tag ã‚’ Post ã®å‹å®šç¾©ã«è¿½åŠ ã™ã‚‹ã€‚

```tsx
// types/post.ts

export type Post = {
  id: string
  Authors: string[]
  Slug: string
  Published: 'Yes' | 'No'
  Date: number
  Page: string
  preview: unknown[][]
  content: PostContent[]
  hasTweet: boolean
  Ogp: string
  Tag: {
    Color: string
    Title: string
    Slug: string
  }[]
}
```

ã‚ã¨ã¯è¦‹ãŸç›®ã«åæ˜ ã™ã‚‹ã ã‘ï¼

ã“ã‚“ãªæ„Ÿã˜ã§å‘¼ã³å‡ºã›ã°ä¸€è¦§ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã§ãã‚‹ï¼

```tsx
// src/components/Blog.tsx

//ã‚¿ã‚°ã®èƒŒæ™¯è‰²ç®—å‡ºã™ã‚‹
const getBlackOrWhite = (hexcolor: string) => {
  const r = parseInt(hexcolor.substr(1, 2), 16)
  const g = parseInt(hexcolor.substr(3, 2), 16)
  const b = parseInt(hexcolor.substr(5, 2), 16)

  return (r * 299 + g * 587 + b * 114) / 1000 < 128 ? 'white' : 'black'
}

//ç•¥
{
  post.Tag.map((t) => (
    <Link key={t.Slug} href={{ pathname: 'blog', query: { tag: t.Slug } }}>
      <a
        className="post-tags__item"
        style={{
          backgroundColor: t.Color,
          color: `${getBlackOrWhite(t.Color || '#ffffff')}`
        }}
      >
        {t.Title}
      </a>
    </Link>
  ))
}
```

ä¸€è¦§ãƒšãƒ¼ã‚¸ã“ã‚“ãªæ„Ÿã˜ï¼

<img
  width={1150}
  height={422}
  src={`https://res.cloudinary.com/dw86z2fnr/image/upload/v1620383433/titanicrising.jp/notion-blog-tag/_2020-09-02_14.39.20_yvwxqh.png`}
/>

è‡ªåˆ†ã®é¸è‰²ã®ã‚»ãƒ³ã‚¹ãŒçµ¶æœ›çš„ã™ãã¦å¾®å¦™â€¦

ã‚„ã£ã±ç™½é»’ã ã‘ã§ã„ã„ã®ã‹ãªã‚â€¦ğŸ¤”
